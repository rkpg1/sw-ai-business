<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d939c8a1e61bfd4e5cc349ec3f2d1e81"></script>

    <title>TasteHouse</title>
<!--

Tooplate 2095 Level

https://www.tooplate.com/view/2095-level

-->
    <!-- load stylesheets -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">  <!-- Google web font "Open Sans" -->
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">                <!-- Font Awesome -->
    <link rel="stylesheet" href="css/bootstrap.min.css">                                      <!-- Bootstrap style -->
    <link rel="stylesheet" type="text/css" href="slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="slick/slick-theme.css"/>
    <link rel="stylesheet" type="text/css" href="css/datepicker.css"/>
    <link rel="stylesheet" href="css/tooplate-style.css?v=1.1">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.css" rel="stylesheet">                               <!-- Templatemo style -->
    <script src="https://cdn.jsdelivr.net/gh/dinoqqq/simple-popup@master/dist/jquery.simple-popup.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/dinoqqq/simple-popup@master/dist/jquery.simple-popup.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
          <![endif]-->

    <style>
        input, textarea, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            color: #333;
        }
    </style>    
    
</head>

    <body>
        <div class="tm-main-content" id="top">
            <div class="tm-top-bar-bg"></div>
            <div class="tm-top-bar" id="tm-top-bar">
                <!-- Top Navbar -->
                <div class="container">
                    <div class="row">
                        
                        <nav class="navbar navbar-expand-lg narbar-light">
                            <a class="navbar-brand mr-auto" href="#">
                                <img src="img/logo.png" alt="Site logo" style="width: 30px;">
                                TasteHouse
                            </a>
                            <button type="button" id="nav-toggle" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#mainNav" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div id="mainNav" class="collapse navbar-collapse tm-bg-white">
                                <ul class="navbar-nav ml-auto">
                                  <li class="nav-item">
                                    <a class="nav-link" href="#top">Search<span class="sr-only">(current)</span></a>
                                  </li>
                                  <li class="nav-item">
                                    <a class="nav-link" href="#tm-section-4">Rankings</a>
                                  </li>
                                  <li class="nav-item">
                                    <a class="nav-link" href="#tm-section-6">Contact Us</a>
                                  </li>
                                </ul>
                            </div>                            
                        </nav>            
                    </div>
                </div>
            </div>
            <div class="tm-section tm-bg-img" id="tm-section-1">
                <div class="tm-bg-white ie-container-width-fix-2">
                    <div class="container ie-h-align-center-fix">
                        <div class="row">
                            <div class="col-xs-12 ml-auto mr-auto ie-container-width-fix">
                                <form action="#" method="get" class="tm-search-form tm-section-pad-2" id="fake-door-form">
                                    <div class="form-row tm-search-form-row">
                                        
                                        <div class="form-group tm-form-element">
                                            <i class="fa fa-map-marker fa-2x tm-form-element-icon"></i>
                                            <input name="destination" type="text" class="form-control" id="inputDestination" placeholder="e.g., Hongdae, Seoul">
                                        </div>
                                        
                                        <div class="form-group tm-form-element">                                            
                                            <select name="food_type" class="form-control tm-select" id="food_type">
                                                <option value="">All Food Types</option>
                                                <option value="korean">Korean</option>
                                                <option value="japanese">Japanese</option>
                                                <option value="chinese">Chinese</option>
                                                <option value="western">Western</option>
                                                <option value="cafe">Cafe / Dessert</option>
                                            </select>
                                            <i class="fa fa-cutlery fa-2x tm-form-element-icon"></i>
                                        </div>
                                        
                                        <div class="form-group tm-form-element">
                                            <button type="submit" class="btn btn-primary tm-btn-search">Find Rankings</button>
                                        </div>
                                        
                                      </div>
                                </form>
                            </div>                        
                        </div>      
                    </div>
                </div>                  
            </div>
            
            <div class="tm-section tm-section-pad tm-bg-gray" id="tm-section-4">
                <div class="container">
                    <div class="row">
                        
                        <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
                            <div class="tm-bg-white">
                                <div class="tm-bg-primary tm-sidebar-pad">
                                    <h3 class="tm-color-white tm-sidebar-title">Sinchon Top Chinese Rankings</h3>
                                    <p class="tm-color-white tm-margin-b-0 tm-font-light">Relative Score with an average of 3.0</p>
                                </div>
                                <div class="tm-sidebar-pad-2" style="padding-bottom: 10px;">
                                    <select id="real-category-filter" class="form-control" style="height: 40px; font-size: 0.9rem;">
                                        <option value="All">All Categories</option>
                                        </select>
                                </div>
                                <div class="tm-sidebar-pad-2" id="restaurant-list-container">
                                </div>
                            </div>                            
                        </div>

                        <div class="col-sm-12 col-md-12 col-lg-8 col-xl-8 mt-4 mt-lg-0">
                            <div id="map-container" class="tm-bg-white">
                                <div id="map" style="width:100%; height:610px;"></div>
                            </div>

                        </div>
                    </div>
                </div> 
            </div>  
            
            <div class="tm-section tm-section-pad tm-bg-img tm-position-relative" id="tm-section-6">
                <div class="container ie-h-align-center-fix">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8 col-xl-7 mt-3 mt-md-0 ml-auto mr-auto">
                            <div class="tm-bg-white tm-p-4">
                                <form action="index.html" method="post" class="contact-form" novalidate>

                                    <p class="contact-text">Please leave your email address, and we will notify you when the service launches.</p>

                                    <div class="form-group">
                                        <input type="email" id="contact_email" name="contact_email" class="form-control" placeholder="Email"/>
                                    </div>

                                    <p class="contact-text" style="margin-top: 25px;">Please give your advice on how you'd like the service to be.</p>

                                    <div class="form-group">
                                        <textarea id="contact_message" name="contact_message" class="form-control" rows="5" placeholder="Message"></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary tm-btn-primary">Send Message Now</button>
                                </form>
                            </div>                            
                        </div>
                    </div>        
                </div>
            </div>
            
            <footer class="tm-bg-dark-blue">
                <div class="row">
                        <p class="col-sm-12 text-center tm-font-light tm-color-white p-4 tm-margin-b-0">
                        Copyright &copy; <span class="tm-current-year">2025</span> Yonsei University
                        
                        - Design: <a rel="nofollow" href="https://www.tooplate.com" class="tm-color-primary tm-font-normal" target="_parent">Tooplate</a></p>        
                </div>            
            </footer>
        </div>
        
        <!-- load JS files -->
        <script src="js/popper.min.js"></script>                    <!-- https://popper.js.org/ -->       
        <script src="js/bootstrap.min.js"></script>                 <!-- https://getbootstrap.com/ -->
        <script src="js/datepicker.min.js"></script>                <!-- https://github.com/qodesmith/datepicker -->
        <script src="js/jquery.singlePageNav.min.js"></script>      <!-- Single Page Nav (https://github.com/ChrisWojcik/single-page-nav) -->
        <script src="slick/slick.min.js"></script>                  <!-- http://kenwheeler.github.io/slick/ -->
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>

            function setCarousel() {
                
                if ($('.tm-article-carousel').hasClass('slick-initialized')) {
                    $('.tm-article-carousel').slick('destroy');
                } 

                if($(window).width() < 438){
                    // Slick carousel
                    $('.tm-article-carousel').slick({
                        infinite: false,
                        dots: true,
                        slidesToShow: 1,
                        slidesToScroll: 1
                    });
                }
                else {
                 $('.tm-article-carousel').slick({
                        infinite: false,
                        dots: true,
                        slidesToShow: 2,
                        slidesToScroll: 1
                    });   
                }
            }

            function setPageNav(){
                if($(window).width() > 991) {
                    $('#tm-top-bar').singlePageNav({
                        currentClass:'active',
                        offset: 79
                    });   
                }
                else {
                    $('#tm-top-bar').singlePageNav({
                        currentClass:'active',
                        offset: 65
                    });   
                }
            }

            // 전역 변수 설정
            var map;
            var allRestaurants = []; // 전체 식당 데이터
            var markers = [];        // 지도에 표시된 마커들
            var currentOverlay = null; // 현재 열린 인포윈도우
       
            $(document).ready(function(){

                /* --- 1. 기본 UI 설정 --- */
                $(window).on("scroll", function() {
                    if($(window).scrollTop() > 100) {
                        $(".tm-top-bar").addClass("active");
                    } else {
                       $(".tm-top-bar").removeClass("active");
                    }
                });      

                setCarousel();
                setPageNav();

                $(window).resize(function() {
                  setCarousel();
                  setPageNav();
                });

                $('.nav-link').click(function(){
                    $('#mainNav').removeClass('show');
                });

                $('.tm-current-year').text(new Date().getFullYear());     

                /* --- 2. 카카오 지도 띄우기 --- */
                var mapContainer = document.getElementById('map'); // 지도를 담을 영역의 DOM 레퍼런스
                
                // [중요] 만약 mapContainer가 없으면 에러가 나므로 확인
                if (mapContainer) {
                    var mapOption = { 
                        center: new kakao.maps.LatLng(37.5575, 126.9372),
                        level: 3,
                        mapTypeId : kakao.maps.MapTypeId.HYBRID
                    };
    
                    map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성
                } else {
                    console.error("지도를 표시할 div(id='map')를 찾을 수 없습니다.");
                }
                
                /* --- 3. 데이터 로드 및 초기화 --- */
                $.getJSON("restaurants.json", function(data) {
                    allRestaurants = data;

                    // (1) 카테고리 필터 자동 생성
                    populateCategoryFilter();

                    // (2) 초기 화면 렌더링
                    updateMapAndList();
                });

                /* --- 4. 이벤트 리스너 등록 --- */
                
                // (1) 지도가 움직이거나 줌인/아웃이 '끝났을 때(idle)' 실행
                kakao.maps.event.addListener(map, 'idle', function() {
                    updateMapAndList();
                });

                // (2) 카테고리 필터를 변경했을 때 실행
                $('#real-category-filter').on('change', function() {
                    updateMapAndList();
                });

                /* --- 5. 검색 버튼 이벤트 --- */
                $("#fake-door-form").on("submit", function(e) {
                    e.preventDefault();
                    // ... (기존 검색 코드 유지) ...
                    $.fn.simplePopup({ type: "html", htmlSelector: "#fake-door-popup" });
                });
            });

            /* --- 핵심 로직 함수들 --- */

            // A. 지도 영역과 필터에 맞춰 데이터 갱신
            function updateMapAndList() {
                if (!map) return;

                var bounds = map.getBounds();
                var selectedCategory = $('#real-category-filter').val();

                var visibleRestaurants = allRestaurants.filter(function(r) {
                    var latlng = new kakao.maps.LatLng(r.lat, r.lng);
                    var isInside = bounds.contain(latlng);
                    var isCategoryMatch = (selectedCategory === "All") || (r.category === selectedCategory);
                    return isInside && isCategoryMatch;
                });

                // [수정] 정렬 로직 변경
                // 리뷰 수가 10개 미만이면 점수를 0으로 취급하여 맨 뒤로 보냄
                visibleRestaurants.sort(function(a, b) {
                    var scoreA = (a.reviews < 10) ? 0 : a.score;
                    var scoreB = (b.reviews < 10) ? 0 : b.score;
                    return scoreB - scoreA; // 내림차순 정렬
                });

                renderMarkers(visibleRestaurants);
                renderList(visibleRestaurants);
            }

            // B. 마커 그리기
            function renderMarkers(restaurants) {
                // 기존 마커 지우기
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                markers = [];

                restaurants.forEach(function(r) {
                    var position = new kakao.maps.LatLng(r.lat, r.lng);
                    
                    // [수정] 점수/리뷰 수에 따른 마커 이미지 선택
                    var imageSrc;
                    if (r.reviews < 10) {
                        imageSrc = 'img/marker-gray.png'; // 리뷰 부족 (회색)
                    } else if (r.score >= 3.5) {
                        imageSrc = 'img/marker-orange.png'; // 고득점 (주황색)
                    } else {
                        imageSrc = 'img/marker-yellow.png'; // 일반 (노란색)
                    }

                    // 마커 이미지의 크기 (아이콘 크기에 맞춰 조절하세요)
                    var imageSize = new kakao.maps.Size(25, 30); 
                    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                    var marker = new kakao.maps.Marker({
                        position: position,
                        map: map,
                        title: r.name,
                        image: markerImage // 커스텀 이미지 적용
                    });

                    // 마커 클릭 이벤트 (기존 유지)
                    kakao.maps.event.addListener(marker, 'click', function() {
                        var $targetItem = $('#' + r.id);
                        if ($targetItem.length) {
                            var container = $('#restaurant-list-container');
                            var targetScroll = $targetItem.position().top + container.scrollTop() - 160;
                            
                            container.animate({ scrollTop: targetScroll }, 500);
                            $('.restaurant-item').removeClass('active-restaurant');
                            $targetItem.addClass('active-restaurant');
                        }
                    });

                    markers.push(marker);
                });
            }

            // C. 리스트 그리기
            function renderList(restaurants) {
                var $listContainer = $('#restaurant-list-container');
                $listContainer.empty();

                if (restaurants.length === 0) {
                    $listContainer.append('<div class="tm-media-body tm-bg-gray p-3">이 영역에는 해당 카테고리의 식당이 없습니다.</div>');
                    return;
                }

                restaurants.forEach(function(r) {
                    // [수정] 별점 표시 로직 개선
                    var ratingHtml = '';
                    
                    // 리뷰 수 10개 미만인 경우
                    if (r.reviews < 10) {
                        ratingHtml = `<span style="color: #999; font-size: 0.9rem;">리뷰 수가 충분하지 않습니다</span>`;
                    } else {
                        // 리뷰 수 충분한 경우 별점 표시
                        var percentage = (r.score / 5.0) * 100;
                        
                        // [수정] 3.5점 이상/미만 색상 클래스 적용
                        var starClass = (r.score >= 3.5) ? 'is-high-score' : 'is-low-score';
                        if (r.score === 0) starClass = 'is-low-score';

                        ratingHtml = `
                            <div class="list-item-rating">
                                <span class="rating-score">${r.score.toFixed(2)}</span>
                                <span class="stars-container">
                                    <span class="stars-background"></span>
                                    <span class="stars-foreground ${starClass}" style="width:${percentage}%"></span>
                                </span>
                                <span class="rating-reviews">(${r.reviews})</span>
                            </div>
                        `;
                    }

                    var html = `
                        <a href="#" class="media tm-media tm-recommended-item restaurant-item" id="${r.id}">
                            <img src="${r.imageSrc}" alt="${r.name}">
                            <div class="media-body tm-media-body tm-bg-gray">
                                <div class="list-item-name">${r.name}</div>
                                <div class="list-item-category">${r.category}</div>
                                ${ratingHtml}
                            </div>
                        </a>`;
                    
                    var $item = $(html);
                    
                    // Fake Door: 리스트 클릭 시 팝업
                    $item.on('click', function(e) {
                        e.preventDefault();
                        
                        var finalData = JSON.stringify({
                            "id": getUVfromCookie(),
                            "action": "click_list_item",
                            "destination": r.id,
                            "food_type": r.category,
                            "time_stamp": getTimeStamp()
                        });
                        
                        // axios.get(...) 

                        $.fn.simplePopup({ type: "html", htmlSelector: "#fake-door-popup" });
                    });

                    $listContainer.append($item);
                });
            }

            // D. 카테고리 필터 옵션 자동 생성
            function populateCategoryFilter() {
                var categories = new Set();
                allRestaurants.forEach(r => categories.add(r.category));
                
                var $select = $('#real-category-filter');
                categories.forEach(cat => {
                    $select.append(`<option value="${cat}">${cat}</option>`);
                });
            }

        </script>
        <script type="application/javascript">
            var ip = "null";
            function getIP(json) {
                console.log(json);
                try {
                    ip = json.ip;
                } catch (e) {
                    ip = 'unknown';
                }
                return;
            }
        </script>
        <script type="application/javascript" src="https://jsonip.com?format=jsonp&callback=getIP"></script>

        <script>

            var mobile = 'desktop';
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // true for mobile device
                mobile = 'mobile';
            }

            var queryString = location.search;
            const urlParams = new URLSearchParams(queryString);
            const utm = urlParams.get("utm");

            function padValue(value) {
                return (value < 10) ? "0" + value : value;
            }

            function getTimeStamp() {
                const date = new Date();

                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const seconds = date.getSeconds();

                const formattedDate = `${padValue(year)}-${padValue(month)}-${padValue(day)} ${padValue(hours)}:${padValue(minutes)}:${padValue(seconds)}`;

                return formattedDate;
            }

            // 쿠키에서 값을 가져오는 함수
            function getCookieValue(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) {
                    return parts.pop().split(";").shift();
                }
            }

            // 쿠키에 값을 저장하는 함수
            function setCookieValue(name, value, days) {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (value || "") + expires + "; path=/";
            }

            function getUVfromCookie() {
                // 6자리 임의의 문자열 생성
                const hash = Math.random().toString(36).substring(2, 8).toUpperCase();
                // 쿠키에서 기존 해시 값을 가져옴
                const existingHash = getCookieValue("user");
                // 기존 해시 값이 없으면, 새로운 해시 값을 쿠키에 저장
                if (!existingHash) {
                    setCookieValue("user", hash, 180); // 쿠키 만료일은 6개월 
                    return hash;
                } else {
                    // 기존 해시 값이 있으면, 기존 값을 반환
                    return existingHash;
                }
            }

            addrScript = "https://script.google.com/macros/s/AKfycbz36e-aBB8UnS61lP1yQThG-g9gTO71_C67l_hF1XM0dwmKWlHh4D0-vaDssFDOlXSI/exec"

            var data = JSON.stringify(
					               {"id": getUVfromCookie(),
							"landingUrl": window.location.href, 
							"ip": ip, 
							"referer": document.referrer,
							"time_stamp": getTimeStamp(), 
							"utm": utm,
							"device": mobile}
							);

            $(document).ready(function () {
                axios.get(addrScript+'?action=insert&table=visitors&data='+data)
				    .then(response => {
							console.log(JSON.stringify(response));
						})
						.catch(error => {
							if (error.response) {
								// 서버가 2xx 범위를 벗어난 상태 코드로 응답한 경우
								console.log(error.response.data);
								console.log(error.response.status);
								console.log(error.response.headers);
							} else if (error.request) {
								// 요청이 전송되었지만 응답을 받지 못한 경우
								console.log(error.request);
							} else {
								// 요청 설정 중에 오류가 발생한 경우
								console.log('Error', error.message);
							}
							console.log(error.config);
						});
                $(".contact-form").on("submit", function (e) {
					const email = $("#contact_email").val();
					const advice = $("#contact_message").val();
                    e.preventDefault()
					function validateEmail(email) {
					    var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
					    return re.test(email);
					}
		    
					if (email == '' || !validateEmail(email)) {
					    alert("The email address is invalid.");
					    return;
					}

                    if (advice == '') {
                        alert("Please leave your feedback about the service.");
                        return;
                    }
		    
					var finalData = JSON.stringify({
					    "id": getUVfromCookie(),
					    "email": email,
					    "advice": advice
					})

                    $.busyLoadFull("show");

					axios.get(addrScript + '?action=insert&table=tab_final&data=' + finalData)
					    .then(response => {
						console.log(response.data.data);
						alert(JSON.stringify(response));
						$('#contact_email').val('');
						$('#contact_message').val('');
                        $.busyLoadFull("hide");
                        $.fn.simplePopup({ type: "html", htmlSelector: "#popup" });
					})
				});
                $("#fake-door-form").on("submit", function(e) {
                    e.preventDefault(); // 페이지 새로고침 방지

                    // 입력된 값 가져오기
                    const destination = $("#inputDestination").val();
                    const foodType = $("#food_type").val();

                    // DB로 보낼 데이터 준비
                    var finalData = JSON.stringify({
                        "id": getUVfromCookie(),
                        "action": "search", // 검색 시도
                        "destination": destination,
                        "food_type": foodType,
                        "time_stamp": getTimeStamp()
                    });

                    $.busyLoadFull("show"); // 로딩 시작

                    axios.get(addrScript + '?action=insert&table=tab_active&data=' + finalData)
                        .then(response => {
                            $.busyLoadFull("hide"); // 로딩 숨기기
                            // 새 팝업 띄우기
                            $.fn.simplePopup({ type: "html", htmlSelector: "#fake-door-popup" }); 
                        })
                        .catch(error => {
                            console.error("Search submit failed:", error);
                            $.busyLoadFull("hide"); // 실패해도 로딩 숨기기
                            // 실패해도 사용자에게는 팝업을 띄워줌
                            $.fn.simplePopup({ type: "html", htmlSelector: "#fake-door-popup" });
                        });
                });

            })

        </script>

<div id="popup" style="display:none; color: #000">
    <h1>감사합니다. </h1>
    <p>이제 우리는 같은 배를 탔습니다.  </p>
</div>

<div id="fake-door-popup" style="display:none; color: #000; max-width: 400px; padding: 20px;">
    <h2>관심을 가져주셔서 감사합니다!</h2>
    <p>
        아직 프로토타이핑 단계로, 이 기능은 현재 준비 중입니다.
    </p>
    <p>
        서비스가 준비되면 알림을 드릴 수 있도록, 페이지 하단에 이메일을 남겨주세요.
    </p>
</div>

</body>
</html>